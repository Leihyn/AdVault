generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  ADVERTISER
  BOTH
}

enum DealStatus {
  PENDING_PAYMENT
  FUNDED
  CREATIVE_PENDING
  CREATIVE_SUBMITTED
  CREATIVE_REVISION
  CREATIVE_APPROVED
  POSTED
  TRACKING
  VERIFIED
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  DISPUTED
  TIMED_OUT
}

enum MetricType {
  POST_EXISTS
  VIEWS
  LIKES
  COMMENTS
  SHARES
  CUSTOM
}

enum RequirementStatus {
  PENDING
  MET
  FAILED
  WAIVED
}

enum Platform {
  TELEGRAM
  YOUTUBE
  INSTAGRAM
  TWITTER
  TIKTOK
}

enum AdFormatType {
  POST
  FORWARD
  STORY
  CUSTOM
  VIDEO
  REEL
  TWEET
  COMMUNITY_POST
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum CreativeStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REVISION_REQUESTED
}

enum TransactionType {
  DEPOSIT
  RELEASE
  REFUND
}

model User {
  id               Int       @id @default(autoincrement())
  telegramId       BigInt    @unique @map("telegram_id")
  username         String?
  firstName        String?   @map("first_name")
  role             UserRole  @default(ADVERTISER)
  tonWalletAddress String?   @map("ton_wallet_address")
  createdAt        DateTime  @default(now()) @map("created_at")

  channels         Channel[]
  channelAdmins    ChannelAdmin[]
  campaigns        Campaign[]
  dealsAsAdvertiser Deal[]   @relation("advertiser_deals")
  creatives        Creative[]
  dealEvents       DealEvent[]

  @@map("users")
}

model Channel {
  id                Int       @id @default(autoincrement())
  platform          Platform  @default(TELEGRAM)
  platformChannelId String    @map("platform_channel_id") @default("")
  telegramChatId    BigInt?   @unique @map("telegram_chat_id")
  ownerId           Int       @map("owner_id")
  title             String
  description       String?
  username          String?
  subscribers       Int       @default(0)
  avgViews          Int       @default(0) @map("avg_views")
  avgReach          Int       @default(0) @map("avg_reach")
  language          String?
  category          String?
  premiumPercentage Decimal   @default(0) @map("premium_percentage") @db.Decimal(10, 4)
  botIsAdmin        Boolean   @default(false) @map("bot_is_admin")
  isVerified        Boolean   @default(false) @map("is_verified")
  verificationToken String?   @map("verification_token")
  verifiedAt        DateTime? @map("verified_at")
  statsUpdatedAt    DateTime? @map("stats_updated_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  owner             User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  admins            ChannelAdmin[]
  adFormats         AdFormat[]
  deals             Deal[]
  applications      CampaignApplication[]
  languageStats     ChannelLanguageStat[]

  @@unique([platform, platformChannelId])
  @@index([ownerId])
  @@index([platform])
  @@map("channels")
}

model ChannelLanguageStat {
  id         Int     @id @default(autoincrement())
  channelId  Int     @map("channel_id")
  language   String
  percentage Decimal @db.Decimal(5, 2)
  channel    Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, language])
  @@map("channel_language_stats")
}

model ChannelAdmin {
  id              Int      @id @default(autoincrement())
  channelId       Int      @map("channel_id")
  userId          Int      @map("user_id")
  canManageDeals  Boolean  @default(false) @map("can_manage_deals")
  canManagePricing Boolean @default(false) @map("can_manage_pricing")
  addedAt         DateTime @default(now()) @map("added_at")

  channel         Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([userId])
  @@map("channel_admins")
}

model AdFormat {
  id          Int          @id @default(autoincrement())
  channelId   Int          @map("channel_id")
  formatType  AdFormatType @map("format_type")
  label       String
  description String?
  priceTon    Decimal      @map("price_ton") @db.Decimal(18, 9)
  isActive    Boolean      @default(true) @map("is_active")

  channel     Channel      @relation(fields: [channelId], references: [id], onDelete: Cascade)
  deals       Deal[]

  @@index([channelId])
  @@map("ad_formats")
}

model Campaign {
  id                   Int            @id @default(autoincrement())
  advertiserId         Int            @map("advertiser_id")
  title                String
  brief                String
  budgetTon            Decimal        @map("budget_ton") @db.Decimal(18, 9)
  targetSubscribersMin Int?           @map("target_subscribers_min")
  targetSubscribersMax Int?           @map("target_subscribers_max")
  targetLanguage       String?        @map("target_language")
  targetCategory       String?        @map("target_category")
  status               CampaignStatus @default(ACTIVE)
  createdAt            DateTime       @default(now()) @map("created_at")

  advertiser           User           @relation(fields: [advertiserId], references: [id], onDelete: Cascade)
  applications         CampaignApplication[]
  deals                Deal[]

  @@index([advertiserId])
  @@index([status])
  @@map("campaigns")
}

model CampaignApplication {
  id              Int               @id @default(autoincrement())
  campaignId      Int               @map("campaign_id")
  channelId       Int               @map("channel_id")
  proposedPriceTon Decimal          @map("proposed_price_ton") @db.Decimal(18, 9)
  message         String?
  status          ApplicationStatus @default(PENDING)
  createdAt       DateTime          @default(now()) @map("created_at")

  campaign        Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  channel         Channel           @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([campaignId, channelId])
  @@index([channelId])
  @@map("campaign_applications")
}

model Deal {
  id                    Int        @id @default(autoincrement())
  channelId             Int        @map("channel_id")
  advertiserId          Int        @map("advertiser_id")
  adFormatId            Int        @map("ad_format_id")
  campaignId            Int?       @map("campaign_id")
  amountTon             Decimal    @map("amount_ton") @db.Decimal(18, 9)
  status                DealStatus @default(PENDING_PAYMENT)
  ownerAlias            String     @map("owner_alias")
  advertiserAlias       String     @map("advertiser_alias")
  escrowAddress         String?    @map("escrow_address")
  escrowMnemonicEncrypted String?  @map("escrow_mnemonic_encrypted")
  verificationWindowHours Int       @default(24) @map("verification_window_hours")
  brief                 String?    @db.Text
  assets                Json?      @db.JsonB
  postProofUrl          String?    @map("post_proof_url")
  platformPostId        String?    @map("platform_post_id")
  trackingStartedAt     DateTime?  @map("tracking_started_at")
  scheduledPostAt        DateTime?  @map("scheduled_post_at")
  contentHash           String?    @map("content_hash")
  postedMessageId       String?    @map("posted_message_id")
  postedAt              DateTime?  @map("posted_at")
  postVerifiedAt        DateTime?  @map("post_verified_at")
  timeoutAt             DateTime?  @map("timeout_at")
  completedAt           DateTime?  @map("completed_at")
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")

  channel               Channel    @relation(fields: [channelId], references: [id], onDelete: Cascade)
  advertiser            User       @relation("advertiser_deals", fields: [advertiserId], references: [id], onDelete: Cascade)
  adFormat              AdFormat   @relation(fields: [adFormatId], references: [id])
  campaign              Campaign?  @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  creatives             Creative[]
  transactions          Transaction[]
  events                DealEvent[]
  pendingTransfers      PendingTransfer[]
  requirements          DealRequirement[]
  dispute               Dispute?

  @@index([channelId])
  @@index([advertiserId])
  @@index([adFormatId])
  @@index([campaignId])
  @@index([status])
  @@index([timeoutAt])
  @@map("deals")
}

model Creative {
  id             Int            @id @default(autoincrement())
  dealId         Int            @map("deal_id")
  contentText    String?        @map("content_text")
  mediaUrl       String?        @map("media_url")
  mediaType      String?        @map("media_type")
  version        Int            @default(1)
  submittedById  Int            @map("submitted_by_id")
  reviewerNotes  String?        @map("reviewer_notes")
  status         CreativeStatus @default(DRAFT)
  createdAt      DateTime       @default(now()) @map("created_at")

  deal           Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)
  submittedBy    User           @relation(fields: [submittedById], references: [id])

  @@index([dealId])
  @@index([submittedById])
  @@map("creatives")
}

model Transaction {
  id            Int             @id @default(autoincrement())
  dealId        Int             @map("deal_id")
  type          TransactionType
  amountTon     Decimal         @map("amount_ton") @db.Decimal(18, 9)
  txHash        String?         @map("tx_hash")
  fromAddress   String?         @map("from_address")
  toAddress     String?         @map("to_address")
  confirmedAt   DateTime?       @map("confirmed_at")
  createdAt     DateTime        @default(now()) @map("created_at")

  deal          Deal            @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("transactions")
}

model DealEvent {
  id         Int      @id @default(autoincrement())
  dealId     Int      @map("deal_id")
  eventType  String   @map("event_type")
  oldStatus  String?  @map("old_status")
  newStatus  String?  @map("new_status")
  actorId    Int?     @map("actor_id")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  deal       Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  actor      User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([dealId])
  @@map("deal_events")
}

model DealReceipt {
  id              Int      @id @default(autoincrement())
  dealId          Int      @unique @map("deal_id")
  channelTitle    String   @map("channel_title")
  advertiserAlias String   @map("advertiser_alias")
  ownerAlias      String   @map("owner_alias")
  amountTon       Decimal  @map("amount_ton") @db.Decimal(18, 9)
  finalStatus     String   @map("final_status")
  dataHash        String   @map("data_hash")
  completedAt     DateTime @map("completed_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("deal_receipts")
}

/// Tracks in-flight two-hop transfers for saga recovery.
/// If hop 1 (escrow→master) succeeds but hop 2 (master→recipient) fails,
/// the recovery worker retries hop 2 using this record.
model PendingTransfer {
  id            Int      @id @default(autoincrement())
  dealId        Int      @map("deal_id")
  type          TransactionType
  recipientAddress String @map("recipient_address")
  amountTon     Decimal  @map("amount_ton") @db.Decimal(18, 9)
  hop1TxId      String?  @map("hop1_tx_id")
  hop2TxId      String?  @map("hop2_tx_id")
  retries       Int      @default(0)
  lastError     String?  @map("last_error")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  deal          Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([completedAt])
  @@map("pending_transfers")
}

enum DisputeStatus {
  OPEN
  MUTUAL_RESOLUTION
  ADMIN_REVIEW
  RESOLVED
}

enum DisputeOutcome {
  RELEASE_TO_OWNER
  REFUND_TO_ADVERTISER
  SPLIT
}

model Dispute {
  id                Int             @id @default(autoincrement())
  dealId            Int             @unique @map("deal_id")
  openedById        Int             @map("opened_by_id")
  reason            String          @db.Text
  status            DisputeStatus   @default(OPEN)

  /// The outcome each party proposes during mutual resolution
  ownerProposal     DisputeOutcome? @map("owner_proposal")
  advertiserProposal DisputeOutcome? @map("advertiser_proposal")
  ownerSplitPercent  Int?           @map("owner_split_percent")
  advertiserSplitPercent Int?       @map("advertiser_split_percent")

  /// Final resolution
  resolvedOutcome   DisputeOutcome? @map("resolved_outcome")
  resolvedSplitPercent Int?         @map("resolved_split_percent")
  resolvedById      Int?            @map("resolved_by_id")
  resolvedReason    String?         @map("resolved_reason") @db.Text

  /// Timeline
  mutualDeadline    DateTime        @map("mutual_deadline")
  escalatedAt       DateTime?       @map("escalated_at")
  resolvedAt        DateTime?       @map("resolved_at")
  createdAt         DateTime        @default(now()) @map("created_at")

  deal              Deal            @relation(fields: [dealId], references: [id], onDelete: Cascade)
  evidence          DisputeEvidence[]

  @@index([status])
  @@map("disputes")
}

model DisputeEvidence {
  id          Int      @id @default(autoincrement())
  disputeId   Int      @map("dispute_id")
  submittedById Int    @map("submitted_by_id")
  description String   @db.Text
  url         String?
  createdAt   DateTime @default(now()) @map("created_at")

  dispute     Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@map("dispute_evidence")
}

model DealRequirement {
  id            Int               @id @default(autoincrement())
  dealId        Int               @map("deal_id")
  metricType    MetricType        @map("metric_type")
  targetValue   Int               @map("target_value")
  currentValue  Int               @default(0) @map("current_value")
  status        RequirementStatus @default(PENDING)
  lastCheckedAt DateTime?         @map("last_checked_at")
  metAt         DateTime?         @map("met_at")
  createdAt     DateTime          @default(now()) @map("created_at")

  deal          Deal              @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("deal_requirements")
}
